"use strict";(()=>{var e={};e.id=2732,e.ids=[2732],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8629:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>S,serverHooks:()=>E,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{POST:()=>p});var s=r(9303),o=r(8716),n=r(670),c=r(7070);let i=require("crypto");var u=r(3538),l=r(6890),d=r(9644);async function p(e,{params:t}){let r=(0,l.k)(e);if(r)return r;let{id:a}=t;try{let e=await u._.lead.findUnique({where:{id:a},include:{_count:{select:{notes:!0}}}});if(!e)return c.NextResponse.json({error:"Lead not found"},{status:404});let t=e._count.notes,r=await u._.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),s=(0,d.M)({lead:e,notesCount:t,rules:r}),o=e.finalScore??e.trustScore,n=s.finalScore-o,l=(0,i.randomUUID)();return await u._.lead.update({where:{id:a},data:{ruleScore:s.ruleScore,finalScore:s.finalScore,trustScore:s.finalScore,trustStatus:s.trustStatus,trustUpdatedAt:new Date}}),s.applied.length>0&&await u._.trustRuleRun.createMany({data:s.applied.map(e=>({leadId:a,ruleCode:e.code,delta:e.delta,scoreBefore:e.before,scoreAfter:e.after,runId:l,actor:"admin"}))}),await u._.trustScoreEvent.create({data:{leadId:a,kind:"RULE_RECALC",scoreBefore:o,scoreAfter:s.finalScore,delta:n,meta:JSON.stringify({runId:l,appliedCount:s.applied.length}),actor:"admin"}}),c.NextResponse.json({success:!0,scoreBefore:o,ruleScore:s.ruleScore,finalScore:s.finalScore,delta:n,status:s.trustStatus,appliedCount:s.applied.length,runId:l})}catch(e){return console.error("[TrustScore Recalc] Error:",e),c.NextResponse.json({error:"Failed to recalculate trust score"},{status:500})}}let S=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cms/leads/[id]/trustscore/recalc/route",pathname:"/api/cms/leads/[id]/trustscore/recalc",filename:"route",bundlePath:"app/api/cms/leads/[id]/trustscore/recalc/route"},resolvedPagePath:"C:\\Users\\MustafaNazliHamiTour\\Desktop\\MedDiscover\\03-platform\\M01-lead-intake\\src\\app\\api\\cms\\leads\\[id]\\trustscore\\recalc\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:E}=S,_="/api/cms/leads/[id]/trustscore/recalc/route";function x(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:m})}},9644:(e,t,r)=>{function a(e){return e>=70?"ACTIVE":e>=50?"RISKY_HIDDEN":"BLACKLISTED"}function s({lead:e,notesCount:t,rules:r}){let s=80,o=[];for(let a of r.filter(e=>e.isActive&&"LEAD"===e.appliesTo)){if(!function(e,t,r){switch(e){case"RULE_MISSING_EMAIL":return!t.email;case"RULE_MISSING_PHONE":return!t.phone;case"RULE_MISSING_NAME":return!(t.name??t.patientName);case"RULE_MISSING_LOCALE":return!t.locale;case"RULE_HAS_NOTE":return r>=1;case"RULE_STATUS_OFFER_SENT":return"OFFER_SENT"===t.status;case"RULE_STATUS_CLOSED":return"CLOSED"===t.status;default:return!1}}(a.code,e,t))continue;let r=s;s+=a.delta,s=Math.max(0,Math.min(100,s)),o.push({code:a.code,delta:a.delta,before:r,after:s})}let n=s,c=null!==e.scoreOverride&&void 0!==e.scoreOverride?e.scoreOverride:n,i=a(c);return{ruleScore:n,finalScore:c,trustStatus:i,applied:o}}r.d(t,{M:()=>s,S:()=>a})}};var t=require("../../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,600],()=>r(8629));module.exports=a})();