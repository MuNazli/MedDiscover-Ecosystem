"use strict";(()=>{var e={};e.id=9598,e.ids=[9598],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3509:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>f,patchFetch:()=>m,requestAsyncStorage:()=>v,routeModule:()=>p,serverHooks:()=>E,staticGenerationAsyncStorage:()=>S});var s={};t.r(s),t.d(s,{PATCH:()=>d});var a=t(9303),o=t(8716),n=t(670),i=t(7070),u=t(3538),l=t(6890),c=t(9644);async function d(e,{params:r}){let t=(0,l.k)(e);if(t)return t;let{id:s}=r;try{let r,t;let{scoreOverride:a,reason:o}=await e.json();if(!validateOverrideScore(a))return i.NextResponse.json({error:"Invalid override score. Must be 0-100 or null."},{status:400});if(o&&"string"==typeof o&&o.length>200)return i.NextResponse.json({error:"Reason too long. Max 200 characters."},{status:400});let n=await u._.lead.findUnique({where:{id:s}});if(!n)return i.NextResponse.json({error:"Lead not found"},{status:404});let l=null!==n.scoreOverride?n.scoreOverride:n.trustScore,d=null===a,p=d?"OVERRIDE_CLEARED":"OVERRIDE_SET",v=null;if(d){let e=await u._.leadNote.count({where:{leadId:s}}),a=await u._.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),o=(0,c.M)({lead:{...n,scoreOverride:null},notesCount:e,rules:a});t=o.finalScore,r=o.trustStatus,v=o.ruleScore}else t=a,r=(0,c.S)(a);let S=t-l;return await u._.lead.update({where:{id:s},data:{scoreOverride:d?null:a,overrideReason:d?null:o||null,overrideBy:d?null:"admin",overrideAt:d?null:new Date,finalScore:t,trustScore:t,trustStatus:r,trustUpdatedAt:new Date,...null!==v?{ruleScore:v}:{}}}),await u._.trustScoreEvent.create({data:{leadId:s,kind:p,scoreBefore:l,scoreAfter:t,delta:S,meta:JSON.stringify({hasReason:!!o}),actor:"admin"}}),i.NextResponse.json({success:!0,action:p,scoreBefore:l,scoreAfter:t,delta:S,status:r})}catch(e){return console.error("[TrustScore Override] Error:",e),i.NextResponse.json({error:"Failed to update trust score override"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cms/leads/[id]/trustscore/override/route",pathname:"/api/cms/leads/[id]/trustscore/override",filename:"route",bundlePath:"app/api/cms/leads/[id]/trustscore/override/route"},resolvedPagePath:"C:\\Users\\MustafaNazliHamiTour\\Desktop\\MedDiscover\\03-platform\\M01-lead-intake\\src\\app\\api\\cms\\leads\\[id]\\trustscore\\override\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:S,serverHooks:E}=p,f="/api/cms/leads/[id]/trustscore/override/route";function m(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:S})}},9644:(e,r,t)=>{function s(e){return e>=70?"ACTIVE":e>=50?"RISKY_HIDDEN":"BLACKLISTED"}function a({lead:e,notesCount:r,rules:t}){let a=80,o=[];for(let s of t.filter(e=>e.isActive&&"LEAD"===e.appliesTo)){if(!function(e,r,t){switch(e){case"RULE_MISSING_EMAIL":return!r.email;case"RULE_MISSING_PHONE":return!r.phone;case"RULE_MISSING_NAME":return!(r.name??r.patientName);case"RULE_MISSING_LOCALE":return!r.locale;case"RULE_HAS_NOTE":return t>=1;case"RULE_STATUS_OFFER_SENT":return"OFFER_SENT"===r.status;case"RULE_STATUS_CLOSED":return"CLOSED"===r.status;default:return!1}}(s.code,e,r))continue;let t=a;a+=s.delta,a=Math.max(0,Math.min(100,a)),o.push({code:s.code,delta:s.delta,before:t,after:a})}let n=a,i=null!==e.scoreOverride&&void 0!==e.scoreOverride?e.scoreOverride:n,u=s(i);return{ruleScore:n,finalScore:i,trustStatus:u,applied:o}}t.d(r,{M:()=>a,S:()=>s})}};var r=require("../../../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,5972,600],()=>t(3509));module.exports=s})();