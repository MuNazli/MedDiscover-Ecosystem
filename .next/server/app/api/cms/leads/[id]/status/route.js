"use strict";(()=>{var e={};e.id=8859,e.ids=[8859],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7795:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>_,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>E,serverHooks:()=>A,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{PATCH:()=>f});var s=a(9303),n=a(8716),i=a(670),o=a(7070),u=a(1067),c=a(6890),d=a(5100),l=a(4659),p=a(3538);let S=u.Ry({status:u.Km(l.PT)});async function f(e,{params:t}){let a=(0,c.k)(e);if(a)return a;let r=await e.json().catch(()=>null),s=S.safeParse(r);if(!s.success)return o.NextResponse.json({error:"Invalid status"},{status:400});if(!await p._.lead.findUnique({where:{id:t.id}}))return o.NextResponse.json({error:"Not found"},{status:404});let n=await (0,d.Wr)(t.id,s.data.status);return o.NextResponse.json({lead:n},{status:200})}let E=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cms/leads/[id]/status/route",pathname:"/api/cms/leads/[id]/status",filename:"route",bundlePath:"app/api/cms/leads/[id]/status/route"},resolvedPagePath:"C:\\Users\\MustafaNazliHamiTour\\Desktop\\MedDiscover\\03-platform\\M01-lead-intake\\src\\app\\api\\cms\\leads\\[id]\\status\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:A}=E,_="/api/cms/leads/[id]/status/route";function w(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:h})}},5100:(e,t,a)=>{a.d(t,{Wf:()=>l,_7:()=>u,Gv:()=>c,Wr:()=>d});var r=a(3538),s=a(4659);function n(e){let[t,a]=e.split("@");if(!t||!a)return e;let r=t[0]??"";return`${r}***@${a}`}function i(e){let t=e.replace(/\D/g,"");if(t.length<=3)return`${t}***`;let a=t.slice(-3);return`***${a}`}var o=a(9644);async function u(e){let t=await r._.lead.findUnique({where:{id:e},include:{notes:{orderBy:{createdAt:"desc"},take:50},audits:{orderBy:{createdAt:"desc"},take:50}}});return t?{...t,status:(0,s.Sb)(t.status),email:t.email?n(t.email):t.email,phone:t.phone?i(t.phone):t.phone}:null}async function c(){return(await r._.lead.findMany({orderBy:{createdAt:"desc"},select:{id:!0,createdAt:!0,locale:!0,name:!0,email:!0,phone:!0,patientName:!0,status:!0,trustScore:!0,trustStatus:!0}})).map(e=>({...e,status:(0,s.Sb)(e.status),email:e.email?n(e.email):e.email,phone:e.phone?i(e.phone):e.phone}))}async function d(e,t){return r._.$transaction(async a=>{let r=await a.lead.update({where:{id:e},data:{status:t}});if(null===r.scoreOverride){let s=await a.leadNote.count({where:{leadId:e}}),n=await a.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),i=(0,o.M)({lead:{...r,status:t,scoreOverride:null},notesCount:s,rules:n});i.finalScore!==r.trustScore&&(await a.lead.update({where:{id:e},data:{ruleScore:i.ruleScore,finalScore:i.finalScore,trustScore:i.finalScore,trustStatus:i.trustStatus,trustUpdatedAt:new Date}}),await a.trustScoreEvent.create({data:{leadId:e,kind:"RULE_RECALC",scoreBefore:r.trustScore,scoreAfter:i.finalScore,delta:i.finalScore-r.trustScore,meta:JSON.stringify({trigger:"status_change"}),actor:"admin"}}))}return await a.leadAudit.create({data:{leadId:e,action:"STATUS_CHANGED",actor:"admin",meta:JSON.stringify({status:t})}}),r})}async function l(e,t){return r._.$transaction(async a=>{let r=await a.leadNote.create({data:{leadId:e,content:t,author:"admin"}}),s=await a.lead.findUnique({where:{id:e}});if(s&&null===s.scoreOverride){let t=await a.leadNote.count({where:{leadId:e}}),r=await a.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),n=(0,o.M)({lead:{...s,scoreOverride:null},notesCount:t,rules:r});n.finalScore!==s.trustScore&&(await a.lead.update({where:{id:e},data:{ruleScore:n.ruleScore,finalScore:n.finalScore,trustScore:n.finalScore,trustStatus:n.trustStatus,trustUpdatedAt:new Date}}),await a.trustScoreEvent.create({data:{leadId:e,kind:"RULE_RECALC",scoreBefore:s.trustScore,scoreAfter:n.finalScore,delta:n.finalScore-s.trustScore,meta:JSON.stringify({trigger:"note_added"}),actor:"admin"}}))}return await a.leadAudit.create({data:{leadId:e,action:"NOTE_ADDED",actor:"admin"}}),r})}},4659:(e,t,a)=>{a.d(t,{PT:()=>r,Sb:()=>n,bQ:()=>s});let r=["NEW","IN_REVIEW","OFFER_SENT","CLOSED"];function s(e){return"NEW"===e||"IN_REVIEW"===e||"OFFER_SENT"===e||"CLOSED"===e}function n(e){return s(e)?e:"IN_REVIEW"}},9644:(e,t,a)=>{function r(e){return e>=70?"ACTIVE":e>=50?"RISKY_HIDDEN":"BLACKLISTED"}function s({lead:e,notesCount:t,rules:a}){let s=80,n=[];for(let r of a.filter(e=>e.isActive&&"LEAD"===e.appliesTo)){if(!function(e,t,a){switch(e){case"RULE_MISSING_EMAIL":return!t.email;case"RULE_MISSING_PHONE":return!t.phone;case"RULE_MISSING_NAME":return!(t.name??t.patientName);case"RULE_MISSING_LOCALE":return!t.locale;case"RULE_HAS_NOTE":return a>=1;case"RULE_STATUS_OFFER_SENT":return"OFFER_SENT"===t.status;case"RULE_STATUS_CLOSED":return"CLOSED"===t.status;default:return!1}}(r.code,e,t))continue;let a=s;s+=r.delta,s=Math.max(0,Math.min(100,s)),n.push({code:r.code,delta:r.delta,before:a,after:s})}let i=s,o=null!==e.scoreOverride&&void 0!==e.scoreOverride?e.scoreOverride:i,u=r(o);return{ruleScore:i,finalScore:o,trustStatus:u,applied:n}}a.d(t,{M:()=>s,S:()=>r})}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,1067,600],()=>a(7795));module.exports=r})();