"use strict";(()=>{var e={};e.id=2215,e.ids=[2215],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1870:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>_,staticGenerationAsyncStorage:()=>E});var r={};a.r(r),a.d(r,{POST:()=>S});var n=a(9303),i=a(8716),s=a(670),o=a(7070),c=a(1067),u=a(6890),d=a(5100),l=a(3538);let p=c.Ry({content:c.Z_().min(2).max(2e3)});async function S(e,{params:t}){let a=(0,u.k)(e);if(a)return a;let r=await e.json().catch(()=>null),n=p.safeParse(r);if(!n.success)return o.NextResponse.json({error:"Invalid note"},{status:400});if(!await l._.lead.findUnique({where:{id:t.id}}))return o.NextResponse.json({error:"Not found"},{status:404});await (0,d.Wf)(t.id,n.data.content.trim());let i=await (0,d._7)(t.id);return o.NextResponse.json({lead:i},{status:200})}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cms/leads/[id]/notes/route",pathname:"/api/cms/leads/[id]/notes",filename:"route",bundlePath:"app/api/cms/leads/[id]/notes/route"},resolvedPagePath:"C:\\Users\\MustafaNazliHamiTour\\Desktop\\MedDiscover\\03-platform\\M01-lead-intake\\src\\app\\api\\cms\\leads\\[id]\\notes\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:E,serverHooks:_}=f,h="/api/cms/leads/[id]/notes/route";function A(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:E})}},5100:(e,t,a)=>{a.d(t,{Wf:()=>l,_7:()=>c,Gv:()=>u,Wr:()=>d});var r=a(3538),n=a(4659);function i(e){let[t,a]=e.split("@");if(!t||!a)return e;let r=t[0]??"";return`${r}***@${a}`}function s(e){let t=e.replace(/\D/g,"");if(t.length<=3)return`${t}***`;let a=t.slice(-3);return`***${a}`}var o=a(9644);async function c(e){let t=await r._.lead.findUnique({where:{id:e},include:{notes:{orderBy:{createdAt:"desc"},take:50},audits:{orderBy:{createdAt:"desc"},take:50}}});return t?{...t,status:(0,n.Sb)(t.status),email:t.email?i(t.email):t.email,phone:t.phone?s(t.phone):t.phone}:null}async function u(){return(await r._.lead.findMany({orderBy:{createdAt:"desc"},select:{id:!0,createdAt:!0,locale:!0,name:!0,email:!0,phone:!0,patientName:!0,status:!0,trustScore:!0,trustStatus:!0}})).map(e=>({...e,status:(0,n.Sb)(e.status),email:e.email?i(e.email):e.email,phone:e.phone?s(e.phone):e.phone}))}async function d(e,t){return r._.$transaction(async a=>{let r=await a.lead.update({where:{id:e},data:{status:t}});if(null===r.scoreOverride){let n=await a.leadNote.count({where:{leadId:e}}),i=await a.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),s=(0,o.M)({lead:{...r,status:t,scoreOverride:null},notesCount:n,rules:i});s.finalScore!==r.trustScore&&(await a.lead.update({where:{id:e},data:{ruleScore:s.ruleScore,finalScore:s.finalScore,trustScore:s.finalScore,trustStatus:s.trustStatus,trustUpdatedAt:new Date}}),await a.trustScoreEvent.create({data:{leadId:e,kind:"RULE_RECALC",scoreBefore:r.trustScore,scoreAfter:s.finalScore,delta:s.finalScore-r.trustScore,meta:JSON.stringify({trigger:"status_change"}),actor:"admin"}}))}return await a.leadAudit.create({data:{leadId:e,action:"STATUS_CHANGED",actor:"admin",meta:JSON.stringify({status:t})}}),r})}async function l(e,t){return r._.$transaction(async a=>{let r=await a.leadNote.create({data:{leadId:e,content:t,author:"admin"}}),n=await a.lead.findUnique({where:{id:e}});if(n&&null===n.scoreOverride){let t=await a.leadNote.count({where:{leadId:e}}),r=await a.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),i=(0,o.M)({lead:{...n,scoreOverride:null},notesCount:t,rules:r});i.finalScore!==n.trustScore&&(await a.lead.update({where:{id:e},data:{ruleScore:i.ruleScore,finalScore:i.finalScore,trustScore:i.finalScore,trustStatus:i.trustStatus,trustUpdatedAt:new Date}}),await a.trustScoreEvent.create({data:{leadId:e,kind:"RULE_RECALC",scoreBefore:n.trustScore,scoreAfter:i.finalScore,delta:i.finalScore-n.trustScore,meta:JSON.stringify({trigger:"note_added"}),actor:"admin"}}))}return await a.leadAudit.create({data:{leadId:e,action:"NOTE_ADDED",actor:"admin"}}),r})}},4659:(e,t,a)=>{a.d(t,{PT:()=>r,Sb:()=>i,bQ:()=>n});let r=["NEW","IN_REVIEW","OFFER_SENT","CLOSED"];function n(e){return"NEW"===e||"IN_REVIEW"===e||"OFFER_SENT"===e||"CLOSED"===e}function i(e){return n(e)?e:"IN_REVIEW"}},9644:(e,t,a)=>{function r(e){return e>=70?"ACTIVE":e>=50?"RISKY_HIDDEN":"BLACKLISTED"}function n({lead:e,notesCount:t,rules:a}){let n=80,i=[];for(let r of a.filter(e=>e.isActive&&"LEAD"===e.appliesTo)){if(!function(e,t,a){switch(e){case"RULE_MISSING_EMAIL":return!t.email;case"RULE_MISSING_PHONE":return!t.phone;case"RULE_MISSING_NAME":return!(t.name??t.patientName);case"RULE_MISSING_LOCALE":return!t.locale;case"RULE_HAS_NOTE":return a>=1;case"RULE_STATUS_OFFER_SENT":return"OFFER_SENT"===t.status;case"RULE_STATUS_CLOSED":return"CLOSED"===t.status;default:return!1}}(r.code,e,t))continue;let a=n;n+=r.delta,n=Math.max(0,Math.min(100,n)),i.push({code:r.code,delta:r.delta,before:a,after:n})}let s=n,o=null!==e.scoreOverride&&void 0!==e.scoreOverride?e.scoreOverride:s,c=r(o);return{ruleScore:s,finalScore:o,trustStatus:c,applied:i}}a.d(t,{M:()=>n,S:()=>r})}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,1067,600],()=>a(1870));module.exports=r})();