"use strict";(()=>{var e={};e.id=8985,e.ids=[8985],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},342:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>m,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>S});var a={};r.r(a),r.d(a,{GET:()=>d});var n=r(9303),i=r(8716),s=r(670),o=r(7070),c=r(6890),u=r(5100);async function d(e,{params:t}){let r=(0,c.k)(e);if(r)return r;let a=await (0,u._7)(t.id);return a?o.NextResponse.json({lead:a},{status:200}):o.NextResponse.json({error:"Not found"},{status:404})}let l=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cms/leads/[id]/route",pathname:"/api/cms/leads/[id]",filename:"route",bundlePath:"app/api/cms/leads/[id]/route"},resolvedPagePath:"C:\\Users\\MustafaNazliHamiTour\\Desktop\\MedDiscover\\03-platform\\M01-lead-intake\\src\\app\\api\\cms\\leads\\[id]\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:S,serverHooks:f}=l,E="/api/cms/leads/[id]/route";function m(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:S})}},5100:(e,t,r)=>{r.d(t,{Wf:()=>l,_7:()=>c,Gv:()=>u,Wr:()=>d});var a=r(3538),n=r(4659);function i(e){let[t,r]=e.split("@");if(!t||!r)return e;let a=t[0]??"";return`${a}***@${r}`}function s(e){let t=e.replace(/\D/g,"");if(t.length<=3)return`${t}***`;let r=t.slice(-3);return`***${r}`}var o=r(9644);async function c(e){let t=await a._.lead.findUnique({where:{id:e},include:{notes:{orderBy:{createdAt:"desc"},take:50},audits:{orderBy:{createdAt:"desc"},take:50}}});return t?{...t,status:(0,n.Sb)(t.status),email:t.email?i(t.email):t.email,phone:t.phone?s(t.phone):t.phone}:null}async function u(){return(await a._.lead.findMany({orderBy:{createdAt:"desc"},select:{id:!0,createdAt:!0,locale:!0,name:!0,email:!0,phone:!0,patientName:!0,status:!0,trustScore:!0,trustStatus:!0}})).map(e=>({...e,status:(0,n.Sb)(e.status),email:e.email?i(e.email):e.email,phone:e.phone?s(e.phone):e.phone}))}async function d(e,t){return a._.$transaction(async r=>{let a=await r.lead.update({where:{id:e},data:{status:t}});if(null===a.scoreOverride){let n=await r.leadNote.count({where:{leadId:e}}),i=await r.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),s=(0,o.M)({lead:{...a,status:t,scoreOverride:null},notesCount:n,rules:i});s.finalScore!==a.trustScore&&(await r.lead.update({where:{id:e},data:{ruleScore:s.ruleScore,finalScore:s.finalScore,trustScore:s.finalScore,trustStatus:s.trustStatus,trustUpdatedAt:new Date}}),await r.trustScoreEvent.create({data:{leadId:e,kind:"RULE_RECALC",scoreBefore:a.trustScore,scoreAfter:s.finalScore,delta:s.finalScore-a.trustScore,meta:JSON.stringify({trigger:"status_change"}),actor:"admin"}}))}return await r.leadAudit.create({data:{leadId:e,action:"STATUS_CHANGED",actor:"admin",meta:JSON.stringify({status:t})}}),a})}async function l(e,t){return a._.$transaction(async r=>{let a=await r.leadNote.create({data:{leadId:e,content:t,author:"admin"}}),n=await r.lead.findUnique({where:{id:e}});if(n&&null===n.scoreOverride){let t=await r.leadNote.count({where:{leadId:e}}),a=await r.trustRule.findMany({where:{isActive:!0,appliesTo:"LEAD"},select:{code:!0,delta:!0,isActive:!0,appliesTo:!0}}),i=(0,o.M)({lead:{...n,scoreOverride:null},notesCount:t,rules:a});i.finalScore!==n.trustScore&&(await r.lead.update({where:{id:e},data:{ruleScore:i.ruleScore,finalScore:i.finalScore,trustScore:i.finalScore,trustStatus:i.trustStatus,trustUpdatedAt:new Date}}),await r.trustScoreEvent.create({data:{leadId:e,kind:"RULE_RECALC",scoreBefore:n.trustScore,scoreAfter:i.finalScore,delta:i.finalScore-n.trustScore,meta:JSON.stringify({trigger:"note_added"}),actor:"admin"}}))}return await r.leadAudit.create({data:{leadId:e,action:"NOTE_ADDED",actor:"admin"}}),a})}},4659:(e,t,r)=>{r.d(t,{PT:()=>a,Sb:()=>i,bQ:()=>n});let a=["NEW","IN_REVIEW","OFFER_SENT","CLOSED"];function n(e){return"NEW"===e||"IN_REVIEW"===e||"OFFER_SENT"===e||"CLOSED"===e}function i(e){return n(e)?e:"IN_REVIEW"}},9644:(e,t,r)=>{function a(e){return e>=70?"ACTIVE":e>=50?"RISKY_HIDDEN":"BLACKLISTED"}function n({lead:e,notesCount:t,rules:r}){let n=80,i=[];for(let a of r.filter(e=>e.isActive&&"LEAD"===e.appliesTo)){if(!function(e,t,r){switch(e){case"RULE_MISSING_EMAIL":return!t.email;case"RULE_MISSING_PHONE":return!t.phone;case"RULE_MISSING_NAME":return!(t.name??t.patientName);case"RULE_MISSING_LOCALE":return!t.locale;case"RULE_HAS_NOTE":return r>=1;case"RULE_STATUS_OFFER_SENT":return"OFFER_SENT"===t.status;case"RULE_STATUS_CLOSED":return"CLOSED"===t.status;default:return!1}}(a.code,e,t))continue;let r=n;n+=a.delta,n=Math.max(0,Math.min(100,n)),i.push({code:a.code,delta:a.delta,before:r,after:n})}let s=n,o=null!==e.scoreOverride&&void 0!==e.scoreOverride?e.scoreOverride:s,c=a(o);return{ruleScore:s,finalScore:o,trustStatus:c,applied:i}}r.d(t,{M:()=>n,S:()=>a})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,600],()=>r(342));module.exports=a})();