"use strict";(()=>{var e={};e.id=7538,e.ids=[7538],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},480:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>b,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>I,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{GET:()=>m,POST:()=>h});var r=t(9303),i=t(8716),n=t(670),o=t(7070),d=t(1067),l=t(3538);let p={email:/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i,phone:/(\+?\d[\d\s().\-]{7,}\d)/,whatsapp:/\b(whatsapp|whats\s*app|wa\.me|wp\b)/i,url:/(https?:\/\/|www\.)/i,socialHandle:/@\w{3,}/,telegram:/\b(telegram|t\.me)\b/i},u=d.Km(["PATIENT","CLINIC","ADMIN"]),c=d.Ry({senderType:u,body:d.Z_().min(1,"Mesaj boş olamaz").max(2e3,"Mesaj en fazla 2000 karakter olabilir")});async function m(e,{params:a}){let{leadId:t}=a,s=await l._.lead.findUnique({where:{id:t},include:{conversation:{include:{messages:{where:{blocked:!1},orderBy:{createdAt:"asc"},take:50}}}}});if(!s)return o.NextResponse.json({error:"Lead bulunamadı"},{status:404});let r=s.conversation?.messages||[];return o.NextResponse.json({messages:r})}async function h(e,{params:a}){let{leadId:t}=a;try{var s;let a=await e.json(),r=c.safeParse(a);if(!r.success){let e={};for(let a of r.error.issues){let t=a.path[0];e[t]||(e[t]=[]),e[t].push(a.message)}return o.NextResponse.json({error:"Validation failed",fieldErrors:e},{status:400})}let i=await l._.lead.findUnique({where:{id:t},include:{conversation:!0}});if(!i)return o.NextResponse.json({error:"Lead bulunamadı"},{status:404});let n=function(e){if(!e||"string"!=typeof e)return{hasPII:!1};if(p.email.test(e))return{hasPII:!0,reason:"E-posta adresi tespit edildi"};let a=e.match(p.phone);return a&&a[0].replace(/\D/g,"").length>=9?{hasPII:!0,reason:"Telefon numarası tespit edildi"}:p.whatsapp.test(e)?{hasPII:!0,reason:"WhatsApp referansı tespit edildi"}:p.url.test(e)?{hasPII:!0,reason:"URL/link tespit edildi"}:p.socialHandle.test(e)?{hasPII:!0,reason:"Sosyal medya kullanıcı adı tespit edildi"}:p.telegram.test(e)?{hasPII:!0,reason:"Telegram referansı tespit edildi"}:{hasPII:!1}}(r.data.body);if(n.hasPII)return o.NextResponse.json({error:"PII detected",fieldErrors:{body:[`İletişim bilgisi paylaşmak yasaktır. ${n.reason||""}`.trim()]}},{status:400});let d=(s=r.data.body)&&"string"==typeof s?s.trim().replace(/\s+/g," ").substring(0,2e3):"",u=i.conversation;u||(u=await l._.conversation.create({data:{leadId:t}}));let m=await l._.message.create({data:{conversationId:u.id,senderType:r.data.senderType,body:d,blocked:!1}});return await l._.conversation.update({where:{id:u.id},data:{updatedAt:new Date}}),o.NextResponse.json({ok:!0,messageId:m.id},{status:201})}catch(e){return console.error("Message send error:",e),o.NextResponse.json({error:"Internal server error",fieldErrors:{}},{status:500})}}let I=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/chat/[leadId]/messages/route",pathname:"/api/chat/[leadId]/messages",filename:"route",bundlePath:"app/api/chat/[leadId]/messages/route"},resolvedPagePath:"C:\\Users\\MustafaNazliHamiTour\\Desktop\\MedDiscover\\03-platform\\M01-lead-intake\\src\\app\\api\\chat\\[leadId]\\messages\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:w}=I,b="/api/chat/[leadId]/messages/route";function y(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},3538:(e,a,t)=>{t.d(a,{_:()=>r});var s=t(3524);let r=globalThis.prisma??new s.PrismaClient}};var a=require("../../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),s=a.X(0,[8948,5972,1067],()=>t(480));module.exports=s})();